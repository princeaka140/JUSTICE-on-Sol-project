<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Notifications</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <style>
    body{ padding:24px; }
    h2{ margin:0 0 12px 0 }
  </style>
</head>
<body>
  <h2>Notifications</h2>
  <div id="notif-area">
    <div id="notif-list" class="notif-list">Loadingâ€¦</div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script src="/assets/api.js"></script>
  <script>
    const listEl = document.getElementById('notif-list')
    const toastContainer = document.getElementById('toastContainer')

    function renderNotifications(items){
      listEl.innerHTML = ''
      if(!items || items.length === 0){ listEl.innerHTML = '<div class="muted">No notifications.</div>'; return }
      items.forEach(n => {
        const div = document.createElement('div'); div.className='notif-item'
        div.innerHTML = `<div>${n.message}</div><div class="time">${new Date(n.created_at).toLocaleString()}</div>`
        listEl.appendChild(div)
      })
    }

    function showToast(title, body){
      const t = document.createElement('div'); t.className='toast'
      t.innerHTML = `<div class="title">${title}</div><div class="body">${body}</div>`
      toastContainer.prepend(t)
      // force reflow then show
      requestAnimationFrame(()=> t.classList.add('show'))
      setTimeout(()=>{ t.classList.remove('show'); t.remove() }, 6000)
    }

    let lastSeen = null
    async function loadNotifications(pollToast = false){
      try{
        const data = await apiFetch('/notifications')
        const items = data.notifications || []
        renderNotifications(items)
        if(pollToast && items.length){
          // if there are new items since lastSeen show toast for the first new message
          const newest = items[0]
          if(!lastSeen || newest.id != lastSeen){
            showToast('New notification', newest.message)
            lastSeen = newest.id
          }
        }
      }catch(e){ console.error('loadNotifications', e); listEl.innerHTML = '<div class="muted">Error loading notifications.</div>' }
    }

    // initial
    loadNotifications(true)
    // poll every 3s and show toast when new notifications arrive
    setInterval(()=> loadNotifications(true), 3000)
  </script>
</body>
</html>
