<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Referrals & Leaderboard</title>
  <style>
    :root {
      --accent: aqua;
      --dark: #000;
      --light-bg: #0a0a0a;
      --text: #fff;
      --card: #111;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: 'Inter', Arial, sans-serif;
      background: var(--dark);
      color: var(--text);
    }

    h2 {
      text-align: center;
      border-radius: 6px;
      padding: 8px 16px;
      animation: pulse 2s infinite;
      width: fit-content;
      margin: 0 auto 15px;
    }

    @keyframes pulse {
      0% { background: var(--accent); color: #000; }
      100% { background: transparent; color: var(--accent); }
    }

    .stats, .leaderboard, .chart-box {
      background: var(--card);
      border: 2px solid var(--accent);
      margin-top: 20px;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(0,255,255,0.15);
    }

    .stats p, .leaderboard p {
      margin: 8px 0;
      font-size: 15px;
    }

    .link-box {
      background: rgba(0,255,255,0.1);
      border: 1px solid var(--accent);
      border-radius: 6px;
      padding: 10px;
      margin-top: 12px;
      word-break: break-word;
      color: var(--accent);
      font-size: 14px;
    }

    button {
      display: inline-block;
      margin-top: 12px;
      padding: 10px 14px;
      background: var(--accent);
      color: #000;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    button:hover {
      background: #00bcd4;
      transform: scale(1.03);
    }

    table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
      border-radius: 8px;
      overflow: hidden;
      font-size: 14px;
    }

    th, td {
      border: 1px solid rgba(255,255,255,0.1);
      padding: 10px 6px;
      text-align: center;
    }

    th {
      background: rgba(255,255,255,0.05);
      color: var(--accent);
      font-weight: 600;
    }

    tr:nth-child(even) {
      background: rgba(255,255,255,0.02);
    }

    .highlight {
      background: rgba(0,255,255,0.15);
      font-weight: bold;
    }

    .chart-box h3 {
      text-align: center;
      color: var(--accent);
    }

    canvas {
      display: block;
      max-width: 100%;
      height: auto !important;
      margin-top: 15px;
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      h2 {
        font-size: 18px;
      }

      .stats, .leaderboard, .chart-box {
        padding: 12px;
      }

      table, th, td {
        font-size: 12px;
      }

      button {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      h2 {
        font-size: 17px;
      }

      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      th, td {
        padding: 8px;
      }

      .stats, .leaderboard, .chart-box {
        margin-top: 16px;
      }
    }
  </style>
</head>
<body>
  <h2>üë• Referrals</h2>

  <div class="stats">
    <p><strong>Total Referrals:</strong> <span id="total">0</span></p>
    <p><strong>Bonus Earned:</strong> <span id="bonus">0</span></p>
    <div class="link-box">
      <strong>Your Referral Link:</strong>
      <p id="refLink">Loading...</p>
    </div>
    <button onclick="generateLink()">Generate New Link</button>
  </div>

  <div class="leaderboard">
    <h3>üèÜ Leaderboard (Top 10)</h3>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr><th>Rank</th><th>Username</th><th>Referrals</th><th>Balance</th></tr>
        </thead>
        <tbody id="leaderboard"></tbody>
      </table>
    </div>
    <p><strong>Your Rank:</strong> <span id="myRank">Loading...</span></p>
  </div>

  <div class="chart-box">
    <h3>üìä Referrals Chart</h3>
    <canvas id="referralChart" height="120"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../app.js"></script>
  <script>
    const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || null;
    let chartInstance = null;

    async function loadReferrals() {
      if (!userId) {
        document.getElementById('refLink').textContent = "No Telegram ID found.";
        return;
      }
      try {
        const data = await apiFetch(`/referrals?user_id=${userId}`);
        document.getElementById('total').textContent = data.referrals;
        document.getElementById('bonus').textContent = data.balance;
        document.getElementById('refLink').textContent = data.referral_link;
      } catch (err) {
        console.error("Referral load error:", err);
      }
    }

    async function generateLink() {
      try {
        const res = await apiFetch(`/referrals/generate?user_id=${userId}`, { method: "POST" });
        document.getElementById('refLink').textContent = res.link;
      } catch (err) { console.error("Link generation error:", err); }
    }

    async function loadLeaderboard() {
      try {
        const leaders = await apiFetch("/referrals/leaderboard");
        const tbody = document.getElementById('leaderboard');
        tbody.innerHTML = "";
        const labels = [];
        const values = [];

        leaders.forEach((u, i) => {
          const row = document.createElement("tr");
          if (u.user_id === userId) row.classList.add("highlight");
          row.innerHTML = `
            <td>${i+1}</td>
            <td>${u.username}</td>
            <td>${u.referrals}</td>
            <td>${u.balance}</td>
          `;
          tbody.appendChild(row);
          labels.push(u.username);
          values.push(u.referrals);
        });

        const rank = await apiFetch(`/referrals/rank?user_id=${userId}`);
        document.getElementById('myRank').textContent = `#${rank.rank} of ${rank.total_users}`;
        updateChart(labels, values);
      } catch (err) { console.error("Leaderboard load error:", err); }
    }

    function updateChart(labels, values) {
      const ctx = document.getElementById('referralChart').getContext('2d');
      if (chartInstance) {
        chartInstance.data.labels = labels;
        chartInstance.data.datasets[0].data = values;
        chartInstance.update();
      } else {
        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: "Referrals",
              data: values,
              backgroundColor: 'rgba(0,255,255,0.4)',
              borderColor: 'rgba(0,255,255,1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
          }
        });
      }
    }

    function refreshAll() {
      loadReferrals();
      loadLeaderboard();
    }

    refreshAll();
    setInterval(refreshAll, 15000);
  </script>
</body>
</html>
